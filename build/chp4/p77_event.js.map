{"version":3,"sources":["../../chp4/p77_event.js"],"names":[],"mappings":";;AAMA;;;;AACA;;;;;;;;;;;;;;;;IAEM,K;;;AACF,qBAAc;AAAA;;AAAA;AAEb;;;EAHe,iBAAO,Y;;AAM3B,IAAI,QAAQ,IAAI,KAAJ,EAAZ;AACA,IAAI,SAAS,OAAb;;;AAGA,MAAM,eAAN,CAAsB,CAAtB;;;AAGA,IAAI,eAAe,SAAf,YAAe,CAAU,QAAV,EAAoB;AACnC,QAAI,cAAc,kBAAQ,WAA1B;AACA,gBAAY,OAAZ,CAAoB,sCAApB,EAA4D,UAAS,GAAT,EAAc,EAAd,EAAkB;AAC1E,YAAI,SAAS,GAAG,UAAH,CAAc,MAAd,EAAsB,IAAtB,CAA2B,EAAC,UAAU,UAAX,EAA3B,CAAb;AACA,eAAO,OAAP,CAAe,UAAC,GAAD,EAAM,GAAN,EAAc;AACzB,qBAAS,GAAT;AACA,eAAG,KAAH;AACH,SAHD;AAIH,KAND;AAOH,CATD;;;AAYA,IAAI,SAAS,SAAT,MAAS,CAAU,QAAV,EAAoB;AAC7B,UAAM,IAAN,CAAW,UAAX,EAAuB,QAAvB;AACA,QAAI,WAAW,OAAf,EAAwB;AACpB,gBAAQ,GAAR,CAAY,UAAZ;AACA,iBAAS,SAAT;AACA,qBAAa,UAAC,MAAD,EAAY;AACrB,kBAAM,IAAN,CAAW,UAAX,EAAuB,MAAvB;AACA,qBAAS,OAAT;AACH,SAHD;AAIH;AACJ,CAVD;;;AAaA,OAAO,UAAC,MAAD,EAAY;AACf,YAAQ,GAAR,CAAY,MAAZ;AACH,CAFD;AAGA,OAAO,UAAC,MAAD,EAAY;AACf,YAAQ,GAAR,CAAY,MAAZ;AACH,CAFD;AAGA,OAAO,UAAC,MAAD,EAAY;AACf,YAAQ,GAAR,CAAY,MAAZ;AACH,CAFD;AAGA,OAAO,UAAC,MAAD,EAAY;AACf,YAAQ,GAAR,CAAY,MAAZ;AACH,CAFD,EAEG,OAAO,UAAC,MAAD,EAAY;AAClB,YAAQ,GAAR,CAAY,MAAZ;AACH,CAFE,EAEA,OAAO,UAAC,MAAD,EAAY;AAClB,YAAQ,GAAR,CAAY,MAAZ;AACH,CAFE;AAGH,OAAO,UAAC,MAAD,EAAY;AACf,YAAQ,GAAR,CAAY,MAAZ;AACH,CAFD,EAEG,OAAO,UAAC,MAAD,EAAY;AAClB,YAAQ,GAAR,CAAY,MAAZ;AACH,CAFE,EAEA,OAAO,UAAC,MAAD,EAAY;AAClB,YAAQ,GAAR,CAAY,MAAZ;AACH,CAFE,EAEA,OAAO,UAAC,MAAD,EAAY;AAClB,YAAQ,GAAR,CAAY,MAAZ;AACH,CAFE,EAEA,OAAO,UAAC,MAAD,EAAY;AAClB,YAAQ,GAAR,CAAY,MAAZ;AACH,CAFE,EAEA,OAAO,UAAC,MAAD,EAAY;AAClB,YAAQ,GAAR,CAAY,MAAZ;AACH,CAFE,EAEA,OAAO,UAAC,MAAD,EAAY;AAClB,YAAQ,GAAR,CAAY,MAAZ;AACH,CAFE,EAEA,OAAO,UAAC,MAAD,EAAY;AAClB,YAAQ,GAAR,CAAY,MAAZ;AACH,CAFE","file":"p77_event.js","sourcesContent":["/**\n * 利用事件队列解决雪崩问题\n *\n *\n * */\n\nimport events from 'events'\nimport mongodb from 'mongodb'\n\nclass Proxy extends events.EventEmitter {\n    constructor() {\n        super();\n    }\n}\n\nlet proxy = new Proxy();\nlet status = 'ready';\n\n// 取消监听限制\nproxy.setMaxListeners(0);\n\n// 业务函数  Mongo如何使用复用, 什么时候close\nlet findXiaoming = function (callback) {\n    let mongoClient = mongodb.MongoClient;\n    mongoClient.connect('mongodb://localhost:27017/deepInNode', function(err, db) {\n        let cursor = db.collection('user').find({username: 'xiaohong'});\n        cursor.toArray((err, doc) => {\n            callback(doc);\n            db.close();\n        });\n    });\n};\n\n// 绑定事件封装逻辑\nlet select = function (callback) {\n    proxy.once('selected', callback);\n    if (status === 'ready') {\n        console.log('querying');\n        status = 'pending';\n        findXiaoming((result) => {\n            proxy.emit('selected', result);\n            status = 'ready';\n        })\n    }\n};\n\n// 展示给用户的api就是一个简单的select\nselect((result) => {\n    console.log(result);\n});\nselect((result) => {\n    console.log(result);\n});\nselect((result) => {\n    console.log(result);\n});\nselect((result) => {\n    console.log(result);\n});select((result) => {\n    console.log(result);\n});select((result) => {\n    console.log(result);\n});\nselect((result) => {\n    console.log(result);\n});select((result) => {\n    console.log(result);\n});select((result) => {\n    console.log(result);\n});select((result) => {\n    console.log(result);\n});select((result) => {\n    console.log(result);\n});select((result) => {\n    console.log(result);\n});select((result) => {\n    console.log(result);\n});select((result) => {\n    console.log(result);\n});\n\n\n\n\n\n// let mongoClient = mongodb.MongoClient;\n// mongoClient.connect('mongodb://localhost:27017/deepInNode', (err, db) => {\n//     if (err) console.log(err);\n//     let cursor  = db.collection('user').find({username: 'xiaohong'});\n//     cursor.toArray((err, result) => {\n//         if (err) console.log(err);\n//         if (result) console.dir(result);\n//         db.close();\n//     });\n//\n//     // db.collection('user').insertMany([{username: 'xiaohong', age: 22}], function(err, result) {\n//     //     console.dir(result);\n//     //     db.close();\n//     // });\n// });\n"]}